#!/usr/bin/env zsh
# TODO: 
# - add disable system animations commands
# - store and load iterm2:
#  - config
#  - color scheme
set -e
dir=$(cd -P -- "$(dirname -- "$0")" && pwd -P)
. $dir/config
. $dir/util

scriptname="macOS user session configuration script"
echo_script_status 0 "$scriptname"

install_brew() {
  echo_fn_status 0 $funcstack[1]

  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

  echo_fn_status 1 $funcstack[1]
}

install_pkg_brew() {
  echo_fn_status 0 $funcstack[1]

  brew tap - $dir/pkg_brew_tap
  brew install - < $dir/pkg_brew
  brew install --cask - < $dir/pkg_brew_cask

  echo_fn_status 1 $funcstack[1]
}

install_nix_user_config() {
  echo_fn_status 0 $funcstack[1]

  temp_path=$(mktemp -d)
  git clone --separate-git-dir=$HOME/.dotfiles_git $cf_git_url_nix_user_config $temp_path
  rsync --recursive --verbose --exclude '.git' $temp_path/ $HOME
  git --git-dir=$HOME/.dotfiles_git/ --work-tree=$HOME config --local status.showUntrackedFiles no

  echo_fn_status 1 $funcstack[1]
}

install_nvim_user_config() {
  echo_fn_status 0 $funcstack[1]

  [ ! -d $HOME/.config ] && mkdir -p $HOME/.config
  git clone $cf_git_url_nvim_user_config $HOME/.config/nvim

  echo_fn_status 1 $funcstack[1]
}

install_nodejs() {
  echo_fn_status 0 $funcstack[1]

  mkdir -p $HOME/.nvm
  export NVM_DIR=$HOME/.nvm
  . $(brew --prefix)/opt/nvm/nvm.sh
  nvm install $cf_nvm_default_nodejs_version
  nvm alias default $cf_nvm_default_nodejs_version
  nvm use default

  echo_fn_status 1 $funcstack[1]
}

install_pkg_npm() {
  echo_fn_status 0 $funcstack[1]

  npm install --global - < $dir/pkg_npm

  echo_fn_status 1 $funcstack[1]
}

main() {
  install_brew
  install_pkg_brew
  install_nix_user_config
  install_nvim_user_config
  install_nodejs
  install_pkg_npm
}

main
echo_script_status 1 "$scriptname"
